# frozen_string_literal: true

require "rails_helper"

RSpec.describe FetchMalwareScanResultsJob do
  describe "#perform" do
    let!(:stale_pending_upload) do
      create(
        :upload,
        malware_scan_result: "pending",
        created_at: 10.minutes.ago,
      )
    end
    let!(:fresh_pending_upload) do
      create(:upload, malware_scan_result: "pending")
    end
    let!(:clean_upload) do
      create(:upload, malware_scan_result: "clean", created_at: 10.minutes.ago)
    end

    it "fetches malware scan results for stale pending uploads" do
      expect(FetchMalwareScanResult).to receive(:call).with(
        upload: stale_pending_upload,
      )
      described_class.perform_now
    end
  end
end
