# frozen_string_literal: true

require "rails_helper"

RSpec.describe UpdateMalwareScanResultJob, type: :job do
  describe "#perform" do
    subject(:perform) { described_class.new.perform(upload) }

    let(:upload) { create(:upload) }

    # rubocop:disable Lint/SuppressedException
    let(:perform_rescue_exception) do
      perform
    rescue StandardError
    end
    # rubocop:enable Lint/SuppressedException

    before { allow(FetchMalwareScanResult).to receive(:call).with(upload:) }

    it "calls the service" do
      expect(FetchMalwareScanResult).to receive(:call).with(upload:)
      perform_rescue_exception
    end

    it "raises an exception" do
      expect { perform }.to raise_error(
        UpdateMalwareScanResultJob::StillPending,
      )
    end
  end
end
