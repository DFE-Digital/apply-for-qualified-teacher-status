# frozen_string_literal: true

require "rails_helper"

RSpec.describe FetchMalwareScanResult do
  describe "#call" do
    let(:upload) { create(:upload) }
    let(:tags_url) { "https://example.com/uploads/xyz123?comp=tags" }
    let(:response_success) { true }
    let(:scan_result) { "No threats found" }
    let(:response_body) { <<-XML.squish }
      <Tags>
        <Tag>
          <Key>Malware Scanning scan result</Key>
          <Value>#{scan_result}</Value>
        </Tag>
      </Tags>
      XML
    let(:stubbed_blob_service) do
      instance_double(Azure::Storage::Blob::BlobService, generate_uri: tags_url)
    end
    let(:stubbed_response) do
      instance_double(
        Azure::Core::Http::HttpResponse,
        success?: response_success,
        body: response_body,
      )
    end
    subject(:fetch_malware_scan_result) { described_class.call(upload:) }

    before do
      allow(Azure::Storage::Blob::BlobService).to receive(:new).and_return(
        stubbed_blob_service,
      )
      allow(stubbed_blob_service).to receive(:call).and_return(stubbed_response)
    end

    it "calls the Azure Storage REST API for the scan result" do
      expect(stubbed_blob_service).to receive(:call).with(:get, tags_url)
      fetch_malware_scan_result
    end

    context "with a successful scan result" do
      it "saves the result" do
        fetch_malware_scan_result
        expect(upload.malware_scan_result).to eq("clean")
      end
    end

    context "with a failed scan result" do
      let(:scan_result) { "Malicious" }

      it "saves the result" do
        fetch_malware_scan_result
        expect(upload.malware_scan_result).to eq("suspect")
      end

      it "enqueues a job to remove the file" do
        expect(RemoveMalwareBlobJob).to receive(:perform_later).with(
          upload_id: upload.id,
        )
        fetch_malware_scan_result
      end
    end

    context "with an unsuccessful response" do
      let(:response_success) { false }
      it "saves an error result" do
        fetch_malware_scan_result
        expect(upload.malware_scan_result).to eq("error")
      end
    end

    context "with a missing attachment" do
      before { allow(upload).to receive(:attachment).and_return(nil) }

      it "does not call the Azure Storage REST API" do
        expect(stubbed_blob_service).not_to receive(:call)
        fetch_malware_scan_result
      end
    end
  end
end
