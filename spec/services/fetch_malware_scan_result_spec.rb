# frozen_string_literal: true

require "rails_helper"

RSpec.describe FetchMalwareScanResult do
  describe "#call" do
    subject(:call) { described_class.call(upload:) }

    let(:upload) { create(:upload) }
    let(:tags_url) { "https://example.com/uploads/xyz123?comp=tags" }
    let(:response_success) { true }
    let(:scan_result) { "No threats found" }
    let(:response_body) { <<-XML.squish }
      <Tags>
        <Tag>
          <Key>Malware Scanning scan result</Key>
          <Value>#{scan_result}</Value>
        </Tag>
      </Tags>
      XML
    let(:stubbed_blob_service) do
      instance_double(AzureBlob::Client, generate_uri: tags_url)
    end
    let(:stubbed_response) do
      instance_double(
        Azure::Core::Http::HttpResponse,
        success?: response_success,
        body: response_body,
      )
    end

    before do
      allow(AzureBlob::Client).to receive(:new).and_return(stubbed_blob_service)
      allow(stubbed_blob_service).to receive(:call).and_return(stubbed_response)
    end

    it "calls the Azure Storage REST API for the scan result" do
      expect(stubbed_blob_service).to receive(:call).with(:get, tags_url)
      call
    end

    context "with a successful scan result" do
      it "saves the result" do
        expect { call }.to change(upload, :malware_scan_clean?).from(false).to(
          true,
        )
      end
    end

    context "with a failed scan result" do
      let(:scan_result) { "Malicious" }

      it "saves the result" do
        expect { call }.to change(upload, :malware_scan_suspect?).from(
          false,
        ).to(true)
      end

      it "enqueues a job to remove the file" do
        expect { call }.to have_enqueued_job(ActiveStorage::PurgeJob)
      end
    end

    context "with an unsuccessful response" do
      let(:response_success) { false }

      it "saves the result" do
        expect { call }.to change(upload, :malware_scan_error?).from(false).to(
          true,
        )
      end
    end
  end
end
