<% application_form = @reference_request.application_form %>

<% content_for :page_title, "#{"Error: " if @form.errors.any?}#{t(".title")}" %>
<% content_for :back_link_url, assessor_interface_application_form_path(application_form) %>

<% work_history = @reference_request.work_history %>
<% can_edit_work_history = AssessorInterface::WorkHistoryPolicy.new(current_staff, work_history).edit? %>

<%= form_with model: @form, url: [:assessor_interface, application_form, @reference_request.assessment, @reference_request], method: :put do |f| %>
  <%= f.govuk_error_summary %>

  <h1 class="govuk-heading-xl"><%= t(".title") %></h1>

  <h2 class="govuk-heading-m">Reference details</h2>

  <%= govuk_summary_list(html_attributes: { id: "reference-details-summary-list" }) do |summary_list|
    summary_list.with_row do |row|
      row.with_key { "Name of institution" }
      row.with_value { work_history.school_name }
    end

    summary_list.with_row do |row|
      row.with_key { "Number of months" }
      row.with_value { WorkHistoryDuration.new(work_history_record: work_history).count_months.to_s }
    end

    summary_list.with_row do |row|
      row.with_key { "Name of reference" }
      row.with_value { work_history.contact_name }

      if can_edit_work_history
        row.with_action(text: "Change", href: [:edit, :assessor_interface, application_form, work_history])
      end
    end

    if can_edit_work_history
      summary_list.with_row do |row|
        row.with_key { "Job title of reference" }
        row.with_value { work_history.contact_job }
        row.with_action(text: "Change", href: [:edit, :assessor_interface, application_form, work_history])
      end

      summary_list.with_row do |row|
        row.with_key { "Email address of reference" }
        row.with_value { work_history.contact_email }
        row.with_action(text: "Change", href: [:edit, :assessor_interface, application_form, work_history])
      end
    end
  end %>

  <% if @reference_request.received? %>
    <%= render "shared/reference_request_summary", reference_request: @reference_request, changeable: false %>

    <%= f.govuk_radio_buttons_fieldset :passed, legend: { text: t(".passed"), size: "s" } do %>
      <%= f.govuk_radio_button :passed, :true, link_errors: true %>
      <%= f.govuk_radio_button :passed, :false do %>
        <%= f.govuk_text_area :note, label: { text: t(".failure_assessor_note").html_safe } %>
      <% end %>
    <% end %>

    <%= f.govuk_submit do %>
      <%= govuk_link_to "Cancel", [:assessor_interface, application_form] %>
    <% end %>
  <% end %>
<% end %>
