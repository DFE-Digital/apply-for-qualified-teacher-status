<% content_for :page_title, title_with_error_prefix(t(".title"), error: @form.errors.any?) %>
<% content_for :back_link_url, assessor_interface_application_form_assessment_prioritisation_reference_requests_path(@view_object.application_form, @assessment) %>

<% work_history = @view_object.work_history %>

<%= form_with model: @form, url: [:assessor_interface, @view_object.application_form, @assessment, @prioritisation_reference_request], method: :put do |f| %>
  <%= f.govuk_error_summary %>

  <h1 class="govuk-heading-xl"><%= t(".title") %></h1>

  <h2 class="govuk-heading-m">
    Reference details
  </h2>

  <%= govuk_summary_list(html_attributes: { id: "prioritisation-reference-details-summary-list" }) do |summary_list|
    summary_list.with_row do |row|
      row.with_key { "Name of institution" }
      row.with_value { work_history.school_name }
    end

    summary_list.with_row do |row|
      row.with_key { "Name of reference" }
      row.with_value { work_history.contact_name }
    end

    summary_list.with_row do |row|
      row.with_key { "Job title of reference" }
      row.with_value { work_history.contact_job }
    end

    summary_list.with_row do |row|
      row.with_key { "Email address of reference" }
      row.with_value do
        if work_history.activate_eligibility_domain_concern?
          tag.div(class: "govuk-form-group govuk-form-group--error") do
            content_tag(:p, "This email domain has been flagged with eligibility concerns", class: "govuk-error-message") +
              work_history.contact_email
          end
        else
          work_history.contact_email
        end
      end
    end
  end %>

  <% if @view_object.can_resend_email? %>
    <p class="govuk-body">The reference was last emailed on <%= @view_object.last_sent_at_local_timestamp.to_fs %>.</p>
  <% end %>

  <% if (@prioritisation_reference_request.received? || @prioritisation_reference_request.expired?) && policy([:assessor_interface, @prioritisation_reference_request]).update? %>
    <% if @prioritisation_reference_request.received? %>
      <%= render "shared/prioritisation_reference_request_summary", prioritisation_reference_request: @prioritisation_reference_request, changeable: false %>
    <% elsif @prioritisation_reference_request.expired? %>
      <%= govuk_warning_text(text: "This reference is overdue.") %>
    <% end %>

    <% if @view_object.can_resend_email? %>
      <%= govuk_button_link_to "Resend reference request email", resend_email_assessor_interface_application_form_assessment_prioritisation_reference_request_path(@view_object.application_form, @assessment, @prioritisation_reference_request), secondary: true %>
    <% end %>

    <%= f.govuk_radio_buttons_fieldset :passed, legend: { text: "Are you satisfied with this reference for the applicantâ€™s work history?", size: "s" } do %>
      <%= f.govuk_radio_button :passed, :true, link_errors: true, disabled: @view_object.disable_form? %>
      <%= f.govuk_radio_button :passed, :false, disabled: @view_object.disable_form? do %>
        <%= f.govuk_text_area :note, label: { text: "Note to the applicant" } %>
      <% end %>
    <% end %>

    <%= f.govuk_submit disabled: @view_object.disable_form? do %>
      <%= render "shared/assessor_interface/cancel_link" %>
    <% end %>
  <% else %>
    <div class="govuk-button-group">
      <%= govuk_button_link_to "Back to check references", assessor_interface_application_form_assessment_prioritisation_reference_requests_path(@assessment.application_form, @assessment) %>
      <%= govuk_button_link_to "Resend reference request email", resend_email_assessor_interface_application_form_assessment_prioritisation_reference_request_path(@view_object.application_form, @assessment, @prioritisation_reference_request), secondary: true %>
    </div>
  <% end %>
<% end %>
