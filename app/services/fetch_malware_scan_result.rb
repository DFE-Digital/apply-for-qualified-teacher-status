# frozen_string_literal: true

require "azure_blob"

class FetchMalwareScanResult
  include ServicePattern

  SCAN_RESULT_TAG_KEY = "Malware Scanning scan result"
  SCAN_RESULT_TAG_VALUE_CLEAN = "no threats found"
  SCAN_RESULT_TAG_VALUE_ERROR = /scan failed/
  SCAN_RESULT_TAG_VALUE_SUSPECT = /malicious/

  def initialize(upload:)
    @upload = upload
  end

  def call
    return unless upload.malware_scan_pending?

    case malware_tag
    when SCAN_RESULT_TAG_VALUE_CLEAN
      upload.malware_scan_clean!
    when SCAN_RESULT_TAG_VALUE_ERROR
      upload.malware_scan_error!
    when SCAN_RESULT_TAG_VALUE_SUSPECT
      upload.malware_scan_suspect!
      upload.attachment.purge_later
    end
  rescue StandardError
    upload.malware_scan_error!
  end

  private

  attr_reader :upload

  def blob_service
    @blob_service ||=
      AzureBlob::Client.new(
        account_name: ENV["AZURE_STORAGE_ACCOUNT_NAME"],
        access_key: ENV["AZURE_STORAGE_ACCESS_KEY"],
        container: ENV["AZURE_STORAGE_CONTAINER"],
      )
  end

  def blob_tags
    @blob_tags ||= blob_service.get_blob_tags(upload.attachment.key)
  end

  def malware_tag
    @malware_tag ||= blob_tags&.dig(SCAN_RESULT_TAG_KEY)&.downcase
  end
end
